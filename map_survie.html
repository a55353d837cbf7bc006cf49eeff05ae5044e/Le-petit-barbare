<!doctype html>
<html>
    <head>
        <meta charset="UTF-8"> 
        <title>map_survie</title>
		<link rel="stylesheet" href="./css/visuel_map1.css" type="text/css">
    </head>

    <body class="body">
        <div class="container" >
			<div class="count">
             	<img class="epee" src="./img/epee.gif"><div id="epee" class="txt_epee">{epee}</div></img>
			
				 <img class="lance" src="./img/masse.gif"><div id="lance" class="txt_lance">{masse}</div></img>
			
			<img class="potion" src="./img/potion_1.png"><div class="txt_potion" id="potion">{potion}</div></img>
			</div>	
			<div id="player-container" class="text-border scale">
                <div id="player-forms">
                    <div class="name-panel">
                        <div id="player-name-panel">{nom}</div>
                        <div id="player-level-panel">{level}</div>
                    </div>
                    <div class="player-life-panel">
                        <div class="life" id = "life"
                             style="width: {life}">
                        <div id = "container">{life}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-border scale" id="enemy-container">
                <div id="enemy-forms">
                    <div id="enemy-life-panel">{m1}</div>
                </div>
            </div>

            <div class='bfld' id = 'bfld'>
                {land}
            </div>
        </div>
	
	<form action="/req_debuter" method="GET">
            <input id="input" type="submit" name="action" value="Retour accueil jeu">
        </form>

        <p/>
        <script>
            let epee = true;
			let lance = false;
			window.addEventListener("keydown", function (event) {
                let newUrl = null;
                let sprite = document.querySelector(".perso");
                console.log(event.keyCode);

                if (event.keyCode === 38 || event.keyCode === 90) {
                    sprite.classList.add('perso_up');

                    newUrl = "http://localhost:5000/move_survie?action=Haut";
                } else if(event.keyCode === 40 || event.keyCode === 83){
                    sprite.classList.add('perso_down');

                    newUrl = "http://localhost:5000/move_survie?action=Bas";
                } else if(event.keyCode === 39 || event.keyCode === 68){
                    sprite.classList.add('perso_right');

                    newUrl = "http://localhost:5000/move_survie?action=Droite";
                } else if(event.keyCode === 37 || event.keyCode === 81){
                    sprite.classList.add('perso_left');

                    newUrl = "http://localhost:5000/move_survie?action=Gauche";
                } else if(event.keyCode === 32){
                	if(lance === true) {
						newUrl = "http://localhost:5000/move_survie?action=Attaquer&arme=lance";
					}else if(epee === true) {
						newUrl = "http://localhost:5000/move_survie?action=Attaquer&arme=epee";
					} else {
						newUrl = "http://localhost:5000/move_survie?action=Attaquer";
					}
				} else if(event.keyCode === 69){
                    newUrl = "http://localhost:5000/move_survie?action=Soigner";
                } else if(event.keyCode === 82){
					epee = true;
					lance = false;
				}else if(event.keyCode === 84){
					lance = true;
					epee = false
				}
				if(newUrl !== null){
                    event.preventDefault();
                    fetch(newUrl)
                        .then(function (reponse) { return reponse.json(); })
                        .then(function (reponse) {
                            // Récupération de l'élément DOM
                            if(reponse.type === 'refresh'){
                                function timed (){
                                    setTimeout(myTime, 500);
                                }
                                timed();
                                function myTime(){
                                    document.getElementById("bfld").innerHTML = reponse.value;
                                }
                                const perso = document.getElementById("container");
                                const life = document.getElementById("life");
                                var bar_life = reponse.life;
								document.getElementById('epee').innerHTML = reponse.epee;
								document.getElementById('lance').innerHTML = reponse.lance;
								document.getElementById('potion').innerHTML = reponse.potion;


                                // Assignation du nouveau HTML
                                perso.innerHTML = reponse.life;
                                life.style.width = bar_life + "%";

                            } else if(reponse.type === 'update') {
                                document.querySelector('html').innerHTML = reponse.value;
                                //window.location = reponse.value;
                            }
                    
                        });
                }
            });
        </script>
    </body>
</html>

